<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper     PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"     "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ch4.mybatis.mapper.VisitorMapper">
	
	<!-- 방문자 신청 메인화면 회사명단 조회 -->
	<select id="companyList" parameterType="map" resultType="map">
		select com_no, com_name
		from company	
	</select>
	
	<!-- 방문자 신청 메인화면 부서명단 조회 -->
	<select id="deptList" parameterType="map" resultType="map">
		select dept_name
		from dept
		where com_no = #{com_no}
	</select>	
	
	<!-- 이전 방문 기록 조회 -->
	<select id="preVisitorApplyList" parameterType="map" resultType="map">
		select visit_no, visit_apply_date, visit_desti, visit_type
				,visit_purps, visit_date, visit_term, visit_day
		from visit_apply
		where com_no = #{com_no}
		and visit_apply_name = #{visit_apply_name}
		and visit_apply_hp = #{visit_apply_hp}
		and visit_apply_date >= #{visit_apply_date1}
		<![CDATA[ and visit_apply_date <= #{visit_apply_date2} ]]>		
	</select>
	
	<!-- 이전 방문 기록 상세 조회 (방문자) -->
	<select id="visitorList" parameterType="map" resultType="map">
		select visitor_name, visitor_hp
		from visitor_mng
		where visit_no = #{visit_no}
	</select>
	
	<!-- 이전 방문 기록 상세 조회 (반입기기) -->
	<select id="equipList" parameterType="map" resultType="map">
		select tkin_model, tkin_kind, tkin_posbl_encc, tkin_brand
		from tkin_mng
		where visit_no = #{visit_no}
	</select>
	
	<!-- 이전 방문 기록 상세 조회 (주차) -->
	<select id="carList" parameterType="map" resultType="map">
		select parking_kind, parking_num, parking_model
		from parking_mng
		where visit_no = #{visit_no}
	</select>
	          	
	<!-- 신청 내용 작성 -->
	<insert id="visitorApplyAdd" parameterType="map">
		insert into visit_apply (com_no, visit_no, visit_apply_name, visit_purps, visit_desti
								,visit_type, visit_date, visit_apply_hp, visit_vhcle_encc, visit_tkin_encc
								,visit_permit_id, visit_notes, visit_term, visit_day)
				values (#{com_no}, #{visit_no}, #{visit_apply_name}, #{visit_purps}, #{visit_desti}
					   ,#{visit_type}, #{visit_date}, #{visit_apply_hp}, #{visit_vhcle_encc}, #{visit_tkin_encc}
		               ,#{visit_permit_id}, #{visit_notes}, #{visit_term}, #{visit_day})
	</insert>
	
	<!-- 신청 내용 작성 (방문자) -->
	<insert id="visitorAdd" parameterType="map">
		insert into visitor_mng(visitor_name, visitor_hp, visit_no)
			values(#{visitor_name},#{visitor_hp},#{visit_no})
	</insert>
	
	<!-- 신청 내용 작성 (반입기기) -->
	<insert id="equipAdd" parameterType="map">
		insert into tkin_mng(tkin_model, tkin_kind, tkin_brand, visit_no)
			values(#{tkin_model}, #{tkin_kind}, #{tkin_brand}, #{visit_no})	
	</insert>
	
	<!-- 신청 내용 작성 (주차) -->
	<insert id="carAdd" parameterType="map">
		insert into parking_mng(parking_kind, parking_num, parking_model, visit_no)
			values(#{parking_kind}, #{parking_num}, #{parking_model}, #{visit_no})
	</insert>
	
	<!-- 방문 신청 내용 신청번호로 조회  -->
	<select id="visitorApplySearch" parameterType="map" resultType="map">
		select visit_no, visit_apply_date, com_name, visit_purps, visit_date, visit_permit_st
				from visit_apply vi, company co
				where vi.com_no = co.com_no
				and visit_no = #{visit_no}
	</select>
	
	<!-- 방문 신청 내용 신청자정보로 조회  -->
	<select id="visitorApplyList" parameterType="map" resultType="map">
		select visit_no, visit_apply_date, com_name, visit_purps, visit_date, visit_permit_st
				from visit_apply vi, company co
				where vi.com_no = co.com_no
				and visit_apply_name = #{visit_apply_name}
				and visit_apply_hp = #{visit_apply_hp}
	</select>
	
	<!-- 방문 신청 한 건에 대한 상세정보 조회 (전체) -->
	<select id="visitorApplyMap" parameterType="map" resultType="map">
		select vi.com_no, visit_no,  visit_apply_name, visit_apply_date, visit_purps, visit_desti
                ,visit_type, visit_date, visit_apply_hp, visit_vhcle_encc, visit_tkin_encc
                ,visit_permit_id, visit_permit_st, visit_notes, visit_term, visit_day
                ,com_name
                from visit_apply vi, company co
                where vi.com_no = co.com_no
                and visit_no = #{visit_no}
	</select>
	
	<!-- 방문 신청 취소 (결제상태 변경) 프로시저-->
   <update id="visitorApplyCancle" parameterType="map" statementType="CALLABLE">
      {call proc_visitorCancle(#{visit_no, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String})}
   </update>
   
	<!-- 방문 신청 변경(방문자,반입기기,주차 삭제) 프로시저 -->
   <update id="visitorSubDelete" parameterType="map" statementType="CALLABLE">
      {call proc_visitorSubDelete(#{visit_no, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String})}
   </update>
	
   <!-- 반출 기록 조회 -->
   <select id="preGoodsApplyList" parameterType="map" resultType="map">
   		select app.aplg_no, aplg_date, aplg_desti, aplg_trans_date, aplg_permit_st
				,aplg_reason, gmng_name 
			from goods_apply app, goods_mng mng
			where app.aplg_no = mng.aplg_no
			and com_no = #{com_no}
			and aplg_name = #{aplg_name}
			and aplg_hp = #{aplg_hp}
			and aplg_date >= #{aplg_date1}
			<![CDATA[ and aplg_date <= #{aplg_date2} ]]>
   </select>
	
   <!-- 반출 기록 상세 조회 -->
   <select id="goodsList" parameterType="map" resultType="map">
      select gmng_name, gmng_type, gmng_quan
            ,gmng_confm, gmng_notes
      from goods_mng
      where aplg_no = #{aplg_no}
   </select>
   
   <!-- 반출 신청 등록 -->
   <insert id="goodsApplyAdd" parameterType="map">
      insert into goods_apply(aplg_no, aplg_name, aplg_reason
                        ,aplg_desti, aplg_trans_date, aplg_hp, com_no)
            values(#{aplg_no}, #{aplg_name}, #{aplg_reason}
                  ,#{aplg_desti}, #{aplg_trans_date}, #{aplg_hp}, #{com_no})
   </insert>
   
   <!-- 반출 물품정보 등록 -->
   <insert id="goodsAdd" parameterType="map">
      insert into goods_mng(aplg_no, gmng_name, gmng_type, gmng_quan)
            values(#{aplg_no}, #{gmng_name}, #{gmng_type}, #{gmng_quan})
   </insert>
   
   <!-- 반입 신청건에 대한 상세정보 조회 -->
   <select id="goodsApplyMap" parameterType="map" resultType="map">
      select aplg_no, aplg_name, aplg_date, aplg_reason
            ,aplg_desti, aplg_trans_date, aplg_hp
            ,aplg_notes, aplg_permit_id, com_no, com_name
      from goods_apply ga, company co
      where ga.com_no = co.com_no
      and aplg_no = #{aplg_no}
   </select>
   
   <!-- 반출 조회 및 승인 결과 신청번호로 조회 -->
   <select id="goodsApplySearch" parameterType="map" resultType="map">
   		select aplg_no, aplg_trans_date, aplg_name, aplg_date, aplg_permit_st, aplg_reason, com_name
   			from goods_apply app, company co
   			where app.com_no = co.com_no
   			and aplg_no = #{aplg_no}
   </select>
   
   <!-- 반출 조회 및 승인 결과 신청자정보로 조회 -->
   <select id="goodsApplyList" parameterType="map" resultType="map">
   		select aplg_no, aplg_trand_date, aplg_date, aplg_permit_st, aplg_reason, com_name
   			from goods_apply app, company co
   			where app.com_no = co.com_no
   			and aplg_name = #{aplg_name}
   			and aplg_hp = #{aplg_hp}
   </select>
   
   <!-- 반출 신청 취소 (결제상태 변경) 프로시저-->
   <update id="goodsApplyCancle" parameterType="map" statementType="CALLABLE">
      {call proc_goodsCancle(#{aplg_no, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String})}
   </update>

	<!-- 반출 변경 -->
	<update id="goodsApplyUpdate" parameterType="map">
		update goods_apply
           set 
                aplg_reason = #{aplg_reason}
                ,aplg_desti = #{aplg_desti}
                ,aplg_trans_date = #{aplg_trans_date}
         where aplg_no = #{aplg_no}
	</update>
	   
   <!-- 반입 신청 변경(물품관리 삭제) -->
   <update id="goodsSubDelete" parameterType="map">
      delete from goods_mng
       where aplg_no = #{aplg_no}
   </update>
   
   <!-- QR코드 조회(visitor) -->
   <select id="visitorQRcode" parameterType="map" resultType="map">
		select confm_qrcode
			from cmg_confm
			where confm_name = #{confm_name}
			and confm_hp = #{confm_hp}
			and confm_no = #{confm_no}
   </select>
   
   <!-- QR코드 조회(goods) -->
   <select id="visitorQRcode" parameterType="map" resultType="map">
   		select confm_qrcode
			from goods_confm
			where confm_no = #{confm_no}
			and confm_name = #{confm_name}
			and aplg_no = {aplg_no}
   </select>
   
</mapper>